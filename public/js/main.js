"use strict";function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var s=0;s<e.length;s++){var n=e[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,s,n){return s&&t(e.prototype,s),n&&t(e,n),e}}();document.addEventListener("DOMContentLoaded",function(){function t(){return t.instance?t.instance:(t.instance=this,this._handlers=null==this._handlers?{}:this._handlers,this.append=function(t){for(var e in t)this._handlers[e]=t[e];return this},this.get=function(t){return this._handlers[t]},this)}function e(e,s,n,o){function a(t,e){t.preventDefault(),n.removeChild(u),t.target.removeEventListener("click",t),r(e)}function r(e){document.removeEventListener("keydown",(new t).get("pause")),new l(new i(n,c[e]),e)}var u=document.createElement("section");u.innerHTML=e,u.classList.add("menu-"+s),n.appendChild(u),n.querySelector("button.play")&&n.querySelector("button.play").addEventListener("click",function(t){a(t,1)}),n.querySelector("button.replay")&&n.querySelector("button.replay").addEventListener("click",function(t){a(t,o)}),n.querySelector("button.next")&&n.querySelector("button.next").addEventListener("click",function(t){a(t,o+1)})}var s=function(){function t(e,s,n){_classCallCheck(this,t);var o=document.createElement("div");o.classList.add("cell"),e.appendChild(o),this.node=e.lastElementChild,this.X=s,this.Y=n,this.setStatus()}return _createClass(t,[{key:"setStatus",value:function(){throw new Error("Abstract method must be overriden by the child class!")}},{key:"status",get:function(){return this._status}}]),t}(),n=function(){function t(e,s,n){_classCallCheck(this,t),e.node.appendChild(document.createElement("div")),this.node=e.node.lastElementChild,this.curX=n.X,this.curY=n.Y,this.speed=0,this.setState("stop"),this._setCss(s),this.copyPosition(n.node)}return _createClass(t,[{key:"_setCss",value:function(t){0==this.node.classList.length&&(this.cssClass=t,this.node.className=t)}},{key:"copyPosition",value:function(t){this.node.style.left=t.offsetLeft+"px",this.node.style.top=t.offsetTop+"px"}},{key:"setState",value:function(t){switch(this._state=t,this._state){case"move-right":this.node.className=this.cssClass+" move right";break;case"move-left":this.node.className=this.cssClass+" move left";break;case"move-up":this.node.className=this.cssClass+" move up";break;case"move-down":this.node.className=this.cssClass+" move down";break;default:this.node.classList.remove("move")}}},{key:"state",get:function(){return this._state}}]),t}(),o=function(){function t(e,s,n){_classCallCheck(this,t);var o=document.createElement("div");o.classList.add("counter"),o.classList.add(n),s.appendChild(o),this.node=s.lastElementChild,this.counter=e||0,this._stopped=!0,this.setStatus("started"),this.nodeUpdate()}return _createClass(t,[{key:"setStatus",value:function(t){this._status=t}},{key:"down",value:function(){return!this._frozen&&(this.counter--,this.nodeUpdate(),!0)}},{key:"pause",value:function(){this._stopped=!this._stopped}},{key:"up",value:function(){return!this._stopped&&(this.counter++,this.nodeUpdate(),!0)}},{key:"nodeUpdate",value:function(){this.node.innerText=this.counter,0==this.counter&&this.setStatus("ended")}},{key:"status",get:function(){return this._status}},{key:"paused",get:function(){return this._stopped}}]),t}(),i=function(){function t(e,s){_classCallCheck(this,t),this.quantity=0,this.dots=0,this.blocks=[],this.node=e,this._stage=s,this.rebuild()}return _createClass(t,[{key:"rebuild",value:function(){this.blocks=[];var t=this;this._removeElements(),t._stage.forEach(function(e,s){t.node.appendChild(document.createElement("div"));var n=t.node.lastElementChild;n.classList.add("row"),e.forEach(function(e,o){t.blocks[o]||(t.blocks[o]=[]),["*","|",1].includes(e)?t.blocks[o][s]=new u(n,o,s):"G"==e?(t.blocks[o][s]=new r(n,o,s),t.blocks[o][s].removeDot(),t.startElement=t.blocks[o][s]):(t.blocks[o][s]=new r(n,o,s),t.dots++),t.quantity++})})}},{key:"_removeElements",value:function(){for(var t=this.node.childNodes.length,e=0;e<t;e++)this.node.removeChild(this.node.childNodes[0])}}]),t}(),a=function(t){function e(t,s){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,"player",s));return n.speed=150,n}return _inherits(e,t),e}(n),r=function(t){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return _inherits(e,t),_createClass(e,[{key:"addDot",value:function(){this._dotted=!0;var t=document.createElement("div");t.classList.add("dot"),this.node.appendChild(t)}},{key:"removeDot",value:function(){return 0!=this.dotted&&(this._dotted=!1,this.node.innerHTML="",!0)}},{key:"setStatus",value:function(){this._status="free",this.node.classList.add("free"),this.addDot()}},{key:"dotted",get:function(){return this._dotted}}]),e}(s),l=function(){function s(n,i){var r=this;_classCallCheck(this,s),this.map=n,this.node=n.node,this.levelNumber=i,this.player=new a(this.map,this.map.startElement),this.dotsCount=new o(this.map.dots,this.node,"dots"),this.timer=new o(0,this.node,"timer"),this.steps=new o(0,this.node,"steps"),this._intId=0,this._handlers=(new t).append({keyDown:function(t){switch(t.preventDefault(),clearInterval(l._intId),t.keyCode){case 38:l._intId=setInterval(l.stepUp.bind(l),l.player.speed);break;case 40:l._intId=setInterval(l.stepDown.bind(l),l.player.speed);break;case 37:l._intId=setInterval(l.stepLeft.bind(l),l.player.speed);break;case 39:l._intId=setInterval(l.stepRight.bind(l),l.player.speed)}},touchStart:function(t){r._touchStart=t.touches[0]},touchMove:function(t){r._touchEnd=t.touches[0],clearInterval(l._intId),Math.abs(r._touchStart.pageX-r._touchEnd.pageX)>Math.abs(r._touchStart.pageY-r._touchEnd.pageY)?l._intId=r._touchStart.pageX>r._touchEnd.pageX?setInterval(l.stepLeft.bind(l),l.player.speed):setInterval(l.stepRight.bind(l),l.player.speed):r._touchStart.pageX-r._touchEnd.pageX<Math.abs(r._touchStart.pageY-r._touchEnd.pageY)&&(l._intId=r._touchStart.pageY>r._touchEnd.pageY?setInterval(l.stepUp.bind(l),l.player.speed):setInterval(l.stepDown.bind(l),l.player.speed))},pause:function(t){t.preventDefault(),27==t.keyCode&&(clearInterval(l._intId),l._toggleControls(),l.node.querySelector("section")?l.node.removeChild(l.node.querySelector("section")):e('<h2>Game paused</h2><h3>Press ESC to continue</h3><button class="replay">Replay</button>',"pause",r.node,r.levelNumber))}});var l=this;this._toggleControls(),this._time=setInterval(function(){r.timer.up()},1e3),document.addEventListener("keydown",this._handlers.get("pause"))}return _createClass(s,[{key:"_toggleControls",value:function(){this.timer.pause(),this.dotsCount.pause(),this.steps.pause(),this.timer.paused?(document.removeEventListener("keydown",this._handlers.get("keyDown")),document.removeEventListener("touchstart",this._handlers.get("touchStart")),document.removeEventListener("touchmove",this._handlers.get("touchMove"))):(document.addEventListener("keydown",this._handlers.get("keyDown")),document.addEventListener("touchstart",this._handlers.get("touchStart")),document.addEventListener("touchmove",this._handlers.get("touchMove")))}},{key:"_move",value:function(t,s){return t&&"walled"!=t.status?(this.player.copyPosition(t.node),this.player.setState(s),this.steps.up(),t.removeDot()&&this.dotsCount.down()&&"ended"==this.dotsCount.status&&(this._toggleControls(),document.removeEventListener("keydown",this._handlers.get("pause")),clearInterval(this._time),e("<h2>Congratulations!</h2>\n          <h3>You've finished the level</h3>\n          <p>You've made #{this.steps.counter}</p>\n          <p>Your time is #{this.timer.counter}</p>\n          <button class=\"next\">Next level</button>","level_passed",this.node,this.levelNumber)),!0):(clearInterval(this._intId),this.player.setState("stop"),!1)}},{key:"stepLeft",value:function(){var t=this.player.curX>0&&(this.map.blocks[this.player.curX-1][this.player.curY]||!1);this._move(t,"move-left")&&this.player.curX--}},{key:"stepRight",value:function(){var t=this.player.curX<this.map.blocks.length-1&&(this.map.blocks[this.player.curX+1][this.player.curY]||!1);this._move(t,"move-right")&&this.player.curX++}},{key:"stepUp",value:function(){var t=this.map.blocks[this.player.curX][this.player.curY-1]||!1;this._move(t,"move-up")&&this.player.curY--}},{key:"stepDown",value:function(){var t=this.map.blocks[this.player.curX][this.player.curY+1]||!1;this._move(t,"move-down")&&this.player.curY++}}]),s}(),u=function(t){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return _inherits(e,t),_createClass(e,[{key:"setStatus",value:function(){this._status="walled",this.node.classList.add("walled")}}]),e}(s),c={1:[[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" ","*","*","*","*","*","*","*","*","*"," ","*","*","*","*","*","*","*","*","*"," "],[" ","*"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","*"," "],[" ","*"," "," ","*","*","*"," "," ","*"," ","*"," "," ","*","*","*"," "," ","*"," "],[" ","*"," ","*"," "," "," ","*"," ","*"," ","*"," ","*"," "," "," ","*"," ","*"," "],[" ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," "],[" ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," "],[" ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," "],[" ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," "],[" ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," "],[" ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," "],[" ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," "],[" ","*"," ","*"," "," "," ","*"," ","*"," ","*"," ","*"," "," "," ","*"," ","*"," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" ","*","*","*","*","*","*","*","*"," ","G"," ","*","*","*","*","*","*","*","*"," "],[" ","*"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","*"," "],[" ","*"," ","*","*"," ","*","*"," ","*"," ","*"," ","*","*"," ","*","*"," ","*"," "],[" ","*"," ","*"," "," "," ","*"," ","*"," ","*"," ","*"," "," "," ","*"," ","*"," "],[" ","*"," "," "," ","*"," "," "," ","*"," ","*"," "," "," ","*"," "," "," ","*"," "],[" ","*","*","*","*","*","*","*","*","*"," ","*","*","*","*","*","*","*","*","*"," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "]]};e('<p>Start game</p><button class="play">PLAY</button>',"new_game",document.getElementById("map"))});