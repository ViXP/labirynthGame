"use strict";function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var s=0;s<e.length;s++){var n=e[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,s,n){return s&&t(e.prototype,s),n&&t(e,n),e}}();document.addEventListener("DOMContentLoaded",function(){function t(){return t.instance?t.instance:(t.instance=this,this._handlers=null==this._handlers?{}:this._handlers,this.append=function(t){for(var e in t)this._handlers[e]=t[e];return this},this.get=function(t){return this._handlers[t]},this)}var e=function(){function t(e,s,n){_classCallCheck(this,t);var i=document.createElement("div");i.classList.add("cell"),e.appendChild(i),this.node=e.lastElementChild,this.X=s,this.Y=n,this.setStatus()}return _createClass(t,[{key:"setStatus",value:function(){throw new Error("Abstract method must be overriden by the child class!")}},{key:"status",get:function(){return this._status}}]),t}(),s=function(){function t(e,s,n){_classCallCheck(this,t),e.node.appendChild(document.createElement("div")),this.node=e.node.lastElementChild,this.curX=n.X,this.curY=n.Y,this.speed=0,this.setState("stop"),this._setCss(s),this.copyPosition(n.node)}return _createClass(t,[{key:"_setCss",value:function(t){0==this.node.classList.length&&(this.cssClass=t,this.node.className=t)}},{key:"copyPosition",value:function(t){this.node.style.left=t.offsetLeft+"px",this.node.style.top=t.offsetTop+"px"}},{key:"setState",value:function(t){switch(this._state=t,this._state){case"move-right":this.node.className=this.cssClass+" move right";break;case"move-left":this.node.className=this.cssClass+" move left";break;case"move-up":this.node.className=this.cssClass+" move up";break;case"move-down":this.node.className=this.cssClass+" move down";break;default:this.node.classList.remove("move")}}},{key:"state",get:function(){return this._state}}]),t}(),n=function(){function t(e,s,n){_classCallCheck(this,t);var i=document.createElement("div");i.classList.add("counter"),i.classList.add(n),s.appendChild(i),this.node=s.lastElementChild,this.counter=e||0,this._stopped=!0,this.setStatus("started"),this.nodeUpdate()}return _createClass(t,[{key:"setStatus",value:function(t){this._status=t}},{key:"down",value:function(){return!this._frozen&&(this.counter--,this.nodeUpdate(),!0)}},{key:"pause",value:function(){this._stopped=!this._stopped}},{key:"up",value:function(){return!this._stopped&&(this.counter++,this.nodeUpdate(),!0)}},{key:"nodeUpdate",value:function(){this.node.innerText=this.counter,0==this.counter&&this.setStatus("ended")}},{key:"status",get:function(){return this._status}},{key:"paused",get:function(){return this._stopped}}]),t}(),i=function(){function t(e,s){_classCallCheck(this,t),this.quantity=0,this.dots=0,this.blocks=[],this.node=e,this._stage=s,this.rebuild()}return _createClass(t,[{key:"rebuild",value:function(){this.blocks=[];var t=this;this._removeElements(),t._stage.forEach(function(e,s){t.node.appendChild(document.createElement("div"));var n=t.node.lastElementChild;n.classList.add("row"),e.forEach(function(e,i){t.blocks[i]||(t.blocks[i]=[]),["*","|",1].includes(e)?t.blocks[i][s]=new l(n,i,s):"G"==e?(t.blocks[i][s]=new r(n,i,s),t.blocks[i][s].removeDot(),t.startElement=t.blocks[i][s]):(t.blocks[i][s]=new r(n,i,s),t.dots++),t.quantity++})})}},{key:"_removeElements",value:function(){if(this.node&&this.node.childNodes)for(var t=this.node.childNodes.length,e=0;e<t;e++)this.node.removeChild(this.node.childNodes[0])}}]),t}(),o=function(){function e(s,n,i,o,a,r){_classCallCheck(this,e);var h=document.createElement("section");h.innerHTML=s,h.classList.add("menu-"+n),i.appendChild(h),this.node=i.querySelector("section");var l=this;return this._hidden=!0,this._handlers=(new t).append({buttonClick:function(t,e){t.preventDefault(),l.play(e)},showHide:function(t){27==t.keyCode&&(l.hidden?l.show():l.hide())}}),this.node.querySelector("button.play")&&this.node.querySelector("button.play").addEventListener("click",function(t){l._handlers.get("buttonClick")(t,1)}),this.node.querySelector("button.replay")&&this.node.querySelector("button.replay").addEventListener("click",function(t){l._handlers.get("buttonClick")(t,o)}),this.node.querySelector("button.next")&&this.node.querySelector("button.next").addEventListener("click",function(t){l._handlers.get("buttonClick")(t,o+1)}),a instanceof Object,r&&document.addEventListener("keydown",this._handlers.get("showHide")),this}return _createClass(e,[{key:"play",value:function(t){this.hide(),new h(new i(this.node.parentElement,u[t]),t),this.destroy()}},{key:"destroy",value:function(){this.node.parentElement.removeChild(this.node),document.removeEventListener("keydown",this._handlers.get("showHide")),document.removeEventListener("click",this._handlers.get("buttonClick"))}},{key:"show",value:function(){this._hidden=!1,this.node.classList.add("show")}},{key:"hide",value:function(){this._hidden=!0,this.node.classList.remove("show")}},{key:"hidden",get:function(){return this._hidden}}]),e}(),a=function(t){function e(t,s){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,"player",s));return n.speed=150,n}return _inherits(e,t),e}(s),r=function(t){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return _inherits(e,t),_createClass(e,[{key:"addDot",value:function(){this._dotted=!0;var t=document.createElement("div");t.classList.add("dot"),this.node.appendChild(t)}},{key:"removeDot",value:function(){return 0!=this.dotted&&(this._dotted=!1,this.node.innerHTML="",!0)}},{key:"setStatus",value:function(){this._status="free",this.node.classList.add("free"),this.addDot()}},{key:"dotted",get:function(){return this._dotted}}]),e}(e),h=function(){function e(s,i){var r=this;_classCallCheck(this,e),this.map=s,this.node=s.node,this.levelNumber=i,this.player=new a(this.map,this.map.startElement),this.dotsCount=new n(this.map.dots,this.node,"dots"),this.timer=new n(0,this.node,"timer"),this.steps=new n(0,this.node,"steps");var h=this;this._intId=0,this._handlers=(new t).append({keyDown:function(t){switch(t.preventDefault(),clearInterval(h._intId),t.keyCode){case 38:h._intId=setInterval(h.stepUp.bind(h),h.player.speed);break;case 40:h._intId=setInterval(h.stepDown.bind(h),h.player.speed);break;case 37:h._intId=setInterval(h.stepLeft.bind(h),h.player.speed);break;case 39:h._intId=setInterval(h.stepRight.bind(h),h.player.speed)}},touchStart:function(t){r._touchStart=t.touches[0]},touchMove:function(t){r._touchEnd=t.touches[0],clearInterval(h._intId),Math.abs(r._touchStart.pageX-r._touchEnd.pageX)>Math.abs(r._touchStart.pageY-r._touchEnd.pageY)?h._intId=r._touchStart.pageX>r._touchEnd.pageX?setInterval(h.stepLeft.bind(h),h.player.speed):setInterval(h.stepRight.bind(h),h.player.speed):r._touchStart.pageX-r._touchEnd.pageX<Math.abs(r._touchStart.pageY-r._touchEnd.pageY)&&(h._intId=r._touchStart.pageY>r._touchEnd.pageY?setInterval(h.stepUp.bind(h),h.player.speed):setInterval(h.stepDown.bind(h),h.player.speed))},pause:function(t){t.preventDefault(),27==t.keyCode&&(clearInterval(h._intId),h._toggleControls())}}),this._pauseMenu=new o('<h2>Game paused</h2><h3>Press ESC to continue</h3><button class="replay">Replay</button>',"pause",this.node,this.levelNumber,void 0,!0),this._finishMenu=new o("\n        <h2>Congratulations!</h2>\n        <h3>You've finished the level</h3>\n        <p>You've made #{this.steps.counter}</p>\n        <p>Your time is #{this.timer.counter}</p>\n        <button class=\"next\">Next level</button>","level_passed",this.node,this.levelNumber),this._toggleControls(),document.removeEventListener("keydown",this._handlers.get("pause")),document.addEventListener("keydown",this._handlers.get("pause")),this._time=setInterval(function(){r.timer.up()},1e3)}return _createClass(e,[{key:"_toggleControls",value:function(){this.timer.pause(),this.dotsCount.pause(),this.steps.pause(),this.timer.paused?(document.removeEventListener("keydown",this._handlers.get("keyDown")),document.removeEventListener("touchstart",this._handlers.get("touchStart")),document.removeEventListener("touchmove",this._handlers.get("touchMove"))):(document.addEventListener("keydown",this._handlers.get("keyDown")),document.addEventListener("touchstart",this._handlers.get("touchStart")),document.addEventListener("touchmove",this._handlers.get("touchMove")))}},{key:"_move",value:function(t,e){return t&&"walled"!=t.status?(this.player.copyPosition(t.node),this.player.setState(e),this.steps.up(),t.removeDot()&&this.dotsCount.down()&&"ended"==this.dotsCount.status&&(this._toggleControls(),document.removeEventListener("keydown",this._handlers.get("pause")),clearInterval(this._time),this._finishMenu.show()),!0):(clearInterval(this._intId),this.player.setState("stop"),!1)}},{key:"stepLeft",value:function(){var t=this.player.curX>0&&(this.map.blocks[this.player.curX-1][this.player.curY]||!1);this._move(t,"move-left")&&this.player.curX--}},{key:"stepRight",value:function(){var t=this.player.curX<this.map.blocks.length-1&&(this.map.blocks[this.player.curX+1][this.player.curY]||!1);this._move(t,"move-right")&&this.player.curX++}},{key:"stepUp",value:function(){var t=this.map.blocks[this.player.curX][this.player.curY-1]||!1;this._move(t,"move-up")&&this.player.curY--}},{key:"stepDown",value:function(){var t=this.map.blocks[this.player.curX][this.player.curY+1]||!1;this._move(t,"move-down")&&this.player.curY++}}]),e}(),l=function(t){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return _inherits(e,t),_createClass(e,[{key:"setStatus",value:function(){this._status="walled",this.node.classList.add("walled")}}]),e}(e),u={1:[[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" ","*","*","*","*","*","*","*","*","*"," ","*","*","*","*","*","*","*","*","*"," "],[" ","*"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","*"," "],[" ","*"," "," ","*","*","*"," "," ","*"," ","*"," "," ","*","*","*"," "," ","*"," "],[" ","*"," ","*"," "," "," ","*"," ","*"," ","*"," ","*"," "," "," ","*"," ","*"," "],[" ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," "],[" ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," "],[" ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," "],[" ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," "],[" ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," "],[" ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," "],[" ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," "],[" ","*"," ","*"," "," "," ","*"," ","*"," ","*"," ","*"," "," "," ","*"," ","*"," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" ","*","*","*","*","*","*","*","*"," ","G"," ","*","*","*","*","*","*","*","*"," "],[" ","*"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","*"," "],[" ","*"," ","*","*"," ","*","*"," ","*"," ","*"," ","*","*"," ","*","*"," ","*"," "],[" ","*"," ","*"," "," "," ","*"," ","*"," ","*"," ","*"," "," "," ","*"," ","*"," "],[" ","*"," "," "," ","*"," "," "," ","*"," ","*"," "," "," ","*"," "," "," ","*"," "],[" ","*","*","*","*","*","*","*","*","*"," ","*","*","*","*","*","*","*","*","*"," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "]]};new o('<p>Start game</p><button class="play">PLAY</button>',"new_game",document.getElementById("map")).show()});