"use strict";function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var n=t[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,s,n){return s&&e(t.prototype,s),n&&e(t,n),t}}();document.addEventListener("DOMContentLoaded",function(){function e(){return e.instance?e.instance:(e.instance=this,this._handlers=null==this._handlers?{}:this._handlers,this.append=function(e){for(var t in e)this._handlers[t]=e[t];return this},this.get=function(e){return this._handlers[e]},this)}var t=function(){function e(t,s,n){_classCallCheck(this,e);var i=document.createElement("div");i.classList.add("cell"),t.appendChild(i),this.node=t.lastElementChild,this.X=s,this.Y=n,this.setStatus()}return _createClass(e,[{key:"setStatus",value:function(){throw new Error("Abstract method must be overriden by the child class!")}},{key:"status",get:function(){return this._status}}]),e}(),s=function(){function e(t,s,n){_classCallCheck(this,e),t.node.appendChild(document.createElement("div")),this.node=t.node.lastElementChild,this.curX=n.X,this.curY=n.Y,this.speed=0,this.setState("stop"),this._setCss(s),this.copyPosition(n.node)}return _createClass(e,[{key:"_setCss",value:function(e){0==this.node.classList.length&&(this.cssClass=e,this.node.className=e)}},{key:"copyPosition",value:function(e){this.node.style.left=e.offsetLeft+"px",this.node.style.top=e.offsetTop+"px"}},{key:"setState",value:function(e){switch(this._state=e,this._state){case"move-right":this.node.className=this.cssClass+" move right";break;case"move-left":this.node.className=this.cssClass+" move left";break;case"move-up":this.node.className=this.cssClass+" move up";break;case"move-down":this.node.className=this.cssClass+" move down";break;default:this.node.classList.remove("move")}}},{key:"state",get:function(){return this._state}}]),e}(),n=function(){function e(t,s,n){_classCallCheck(this,e);var i=document.createElement("div");i.classList.add("counter"),i.classList.add(n),s.appendChild(i),this.node=s.lastElementChild,this.counter=t||0,this._stopped=!0,this.setStatus("started"),this.nodeUpdate()}return _createClass(e,[{key:"setStatus",value:function(e){this._status=e}},{key:"down",value:function(){return!this._frozen&&(this.counter--,this.nodeUpdate(),!0)}},{key:"pause",value:function(){this._stopped=!this._stopped}},{key:"up",value:function(){return!this._stopped&&(this.counter++,this.nodeUpdate(),!0)}},{key:"nodeUpdate",value:function(){this.node.innerText=this.counter,0==this.counter&&this.setStatus("ended")}},{key:"status",get:function(){return this._status}},{key:"paused",get:function(){return this._stopped}}]),e}(),i=function(e){function t(e,s){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,"enemy",s));return n.speed=150,n}return _inherits(t,e),t}(s),o=function e(t,s){_classCallCheck(this,e),this.quantity=0,this.dots=0,this.node=t,this.blocks=[],this.enemiesPos=[],this.playerPos="",this._stage=s;var n=this;this._stage.forEach(function(e,t){n.node.appendChild(document.createElement("div"));var s=n.node.lastElementChild;s.classList.add("row"),e.forEach(function(e,i){n.blocks[i]||(n.blocks[i]=[]),["*","|",1].includes(e)?n.blocks[i][t]=new l(s,i,t):"P"==e?(n.blocks[i][t]=new h(s,i,t),n.blocks[i][t].removeDot(),n.playerPos=n.blocks[i][t]):"E"==e?(n.blocks[i][t]=new h(s,i,t),n.enemiesPos.push(n.blocks[i][t])):(n.blocks[i][t]=new h(s,i,t),n.dots++),n.quantity++})})},a=function(){function t(s,n,i,o,a,r){_classCallCheck(this,t);var h=document.createElement("section");h.innerHTML=s,h.classList.add("menu-"+n),i.appendChild(h),this.node=i.querySelector(".menu-"+n);var u=this;return this._hidden=!0,this._handlers=(new e).append({buttonClick:function(e,t){e.preventDefault(),u.play(t)},showHide:function(e){27==e.keyCode&&(u.hidden?u.show():u.hide())}}),this.node.querySelector("button.play")&&this.node.querySelector("button.play").addEventListener("click",function(e){u._handlers.get("buttonClick")(e,1)}),this.node.querySelector("button.replay")&&this.node.querySelector("button.replay").addEventListener("click",function(e){u._handlers.get("buttonClick")(e,o)}),this.node.querySelector("button.next")&&this.node.querySelector("button.next").addEventListener("click",function(e){u._handlers.get("buttonClick")(e,o+1)}),Object,r?document.addEventListener("keydown",this._handlers.get("showHide")):document.removeEventListener("keydown",this._handlers.get("showHide")),this}return _createClass(t,[{key:"play",value:function(e){this.hide(),document.removeEventListener("keydown",this._handlers.get("showHide")),document.removeEventListener("click",this._handlers.get("buttonClick")),new u(this.node.parentElement,c[e],e)}},{key:"show",value:function(){this._hidden=!1,this.node.classList.add("show")}},{key:"hide",value:function(){this._hidden=!0,this.node.classList.remove("show")}},{key:"hidden",get:function(){return this._hidden}}]),t}(),r=function(e){function t(e,s){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,"player",s));return n.speed=150,n}return _inherits(t,e),t}(s),h=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"addDot",value:function(){this._dotted=!0;var e=document.createElement("div");e.classList.add("dot"),this.node.appendChild(e)}},{key:"removeDot",value:function(){return 0!=this.dotted&&(this._dotted=!1,this.node.innerHTML="",!0)}},{key:"setStatus",value:function(){this._status="free",this.node.classList.add("free"),this.addDot()}},{key:"dotted",get:function(){return this._dotted}}]),t}(t),u=function(){function t(s,h,u){var l=this;_classCallCheck(this,t),this._resetDom(s),this.node=s,this.map=new o(this.node,h),this.levelNumber=u,this.player=new r(this.map,this.map.playerPos),this.dotsCount=new n(this.map.dots,this.node,"dots"),this.timer=new n(0,this.node,"timer"),this.steps=new n(0,this.node,"steps"),this.enemies=[];var c=this;this._intId=0,this._handlers=(new e).append({keyDown:function(e){switch(e.preventDefault(),clearInterval(c._intId),e.keyCode){case 38:c._intId=setInterval(c.stepUp.bind(c),c.player.speed);break;case 40:c._intId=setInterval(c.stepDown.bind(c),c.player.speed);break;case 37:c._intId=setInterval(c.stepLeft.bind(c),c.player.speed);break;case 39:c._intId=setInterval(c.stepRight.bind(c),c.player.speed)}},touchStart:function(e){l._touchStart=e.touches[0]},touchMove:function(e){l._touchEnd=e.touches[0],clearInterval(c._intId),Math.abs(l._touchStart.pageX-l._touchEnd.pageX)>Math.abs(l._touchStart.pageY-l._touchEnd.pageY)?c._intId=l._touchStart.pageX>l._touchEnd.pageX?setInterval(c.stepLeft.bind(c),c.player.speed):setInterval(c.stepRight.bind(c),c.player.speed):l._touchStart.pageX-l._touchEnd.pageX<Math.abs(l._touchStart.pageY-l._touchEnd.pageY)&&(c._intId=l._touchStart.pageY>l._touchEnd.pageY?setInterval(c.stepUp.bind(c),c.player.speed):setInterval(c.stepDown.bind(c),c.player.speed))},pause:function(e){e.preventDefault(),27==e.keyCode&&(clearInterval(c._intId),c._toggleControls())}}),this._menus={pauseMenu:new a('<h2>Game paused</h2><h3>Press ESC to continue</h3><button class="replay">&#8635;</button>',"pause",this.node,this.levelNumber,void 0,!0),failedMenu:new a('<h2>You\'ve lost! :(</h2><p>The enemy ate you</p><button class="replay">&#8635;</button>',"failed",this.node,this.levelNumber),finishMenu:new a("\n          <h2>Congratulations!</h2>\n          <h3>You've finished the level</h3>\n          <p>You've made #{this.steps.counter}</p>\n          <p>Your time is #{this.timer.counter}</p>\n          <button class=\"next\">Next level</button>","level_passed",this.node,this.levelNumber)};for(var d in this.map.enemiesPos)this.enemies.push(new i(this.map,this.map.enemiesPos[d]));this._toggleControls(),document.removeEventListener("keydown",this._handlers.get("pause")),document.addEventListener("keydown",this._handlers.get("pause")),this._time=setInterval(function(){l.timer.up()},1e3)}return _createClass(t,[{key:"_resetDom",value:function(e){if(e&&e.childNodes)for(var t=e.childNodes.length,s=0;s<t;s++)e.removeChild(e.childNodes[0])}},{key:"_toggleControls",value:function(){this.timer.pause(),this.dotsCount.pause(),this.steps.pause(),this.timer.paused?(document.removeEventListener("keydown",this._handlers.get("keyDown")),document.removeEventListener("touchstart",this._handlers.get("touchStart")),document.removeEventListener("touchmove",this._handlers.get("touchMove"))):(document.addEventListener("keydown",this._handlers.get("keyDown")),document.addEventListener("touchstart",this._handlers.get("touchStart")),document.addEventListener("touchmove",this._handlers.get("touchMove")))}},{key:"_move",value:function(e,t){if(e&&"walled"!=e.status){this.player.copyPosition(e.node),this.player.setState(t),this.steps.up(),e.removeDot()&&this.dotsCount.down()&&"ended"==this.dotsCount.status&&this._gameOver(this._menus.finishMenu);for(var s in this.enemies)this.player.curX==this.enemies[s].curX&&this.player.curY==this.enemies[s].curY&&this._gameOver(this._menus.failedMenu);return!0}return clearInterval(this._intId),this.player.setState("stop"),!1}},{key:"_gameOver",value:function(e){this._toggleControls(),document.removeEventListener("keydown",this._handlers.get("pause")),clearInterval(this._time),e.show()}},{key:"stepLeft",value:function(){var e=this.player.curX>0&&(this.map.blocks[this.player.curX-1][this.player.curY]||!1);this._move(e,"move-left")&&this.player.curX--}},{key:"stepRight",value:function(){var e=this.player.curX<this.map.blocks.length-1&&(this.map.blocks[this.player.curX+1][this.player.curY]||!1);this._move(e,"move-right")&&this.player.curX++}},{key:"stepUp",value:function(){var e=this.map.blocks[this.player.curX][this.player.curY-1]||!1;this._move(e,"move-up")&&this.player.curY--}},{key:"stepDown",value:function(){var e=this.map.blocks[this.player.curX][this.player.curY+1]||!1;this._move(e,"move-down")&&this.player.curY++}}]),t}(),l=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"setStatus",value:function(){this._status="walled",this.node.classList.add("walled")}}]),t}(t),c={1:[[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" ","*","*","*","*","*","*","*","*","*"," ","*","*","*","*","*","*","*","*","*"," "],[" ","*"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","*"," "],[" ","*"," "," ","*","*","*"," "," ","*"," ","*"," "," ","*","*","*"," "," ","*"," "],[" ","*"," ","*"," "," "," ","*"," ","*"," ","*"," ","*"," "," "," ","*"," ","*"," "],[" ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," "],[" ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," "],[" ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," "],[" ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," "],[" ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," "],[" ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," "],[" ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," ","*"," "],[" ","*"," ","*"," "," "," ","*"," ","*"," ","*"," ","*"," "," "," ","*"," ","*"," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" ","*","*","*","*","*","*","*","*"," ","P"," ","*","*","*","*","*","*","*","*"," "],[" ","*"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","*"," "],[" ","*"," ","*","*"," ","*","*"," ","*"," ","*"," ","*","*"," ","*","*"," ","*"," "],[" ","*"," ","*"," ","E"," ","*"," ","*"," ","*"," ","*"," ","E"," ","*"," ","*"," "],[" ","*"," "," "," ","*"," "," "," ","*"," ","*"," "," "," ","*"," "," "," ","*"," "],[" ","*","*","*","*","*","*","*","*","*"," ","*","*","*","*","*","*","*","*","*"," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "]]};new a('<p>Start game</p><button class="play">PLAY</button>',"new_game",document.getElementById("map")).show()});